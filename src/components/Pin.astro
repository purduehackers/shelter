---
import GliderPin from "../assets/Glider_Pin.png";
import ImaginalPin from "../assets/Imaginal_Pin.png";
import SeveredPin from "../assets/Severed_Pin.png";
import StrawberryPin from "../assets/Strawberry_Pin.png";

interface Props {
    seed: string; // String to hash for randomness (e.g., project name + description)
    hashOffset?: number; // Use different bits of the hash for variety
    cssColor?: string; // Fallback CSS pin color (e.g., "bg-red-500")
    position?: "center" | "left" | "right"; // Pin positioning
    topOffset?: number; // Additional top offset in pixels
}

const {
    seed,
    hashOffset = 0,
    cssColor = "bg-red-500",
    position = "center",
    topOffset = 0,
} = Astro.props;

// Simple seeded random for deterministic results
function seededRandom(s: number): () => number {
    return () => {
        s = (s * 1103515245 + 12345) & 0x7fffffff;
        return s / 0x7fffffff;
    };
}

// Create a seed from a string
function createSeed(str: string, offset: number = 0): number {
    let hash = offset + 5381;
    for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) + hash + str.charCodeAt(i)) | 0;
    }
    return Math.abs(hash);
}

const seedValue = createSeed(seed, hashOffset * 7919);
const random = seededRandom(seedValue);

// Image pins with random rotation Â±20 degrees
const pinImages = [GliderPin, ImaginalPin, SeveredPin, StrawberryPin];
const useImagePin = random() < 0.67; // 67% chance of image pin
const selectedPinImage = pinImages[Math.floor(random() * pinImages.length)];
const pinRotationDeg = Math.floor(random() * 41) - 20; // -20 to +20

// Position classes
const positionClasses = {
    center: "left-1/2 -translate-x-1/2",
    left: "left-8",
    right: "right-8",
};
const posClass = positionClasses[position];
const imagePinTransform =
    position === "center"
        ? `translateX(-50%) rotate(${pinRotationDeg}deg)`
        : `rotate(${pinRotationDeg}deg)`;

// Calculate top positions with offset
const imageTop = -24 + topOffset; // -24px = -top-6
const cssTop = -12 + topOffset; // -12px = -top-3
---

{
    useImagePin ? (
        <div
            class={`absolute z-50 ${posClass}`}
            style={`top: ${imageTop}px; transform: ${imagePinTransform};`}
        >
            <img
                src={selectedPinImage.src}
                alt="Pin"
                class="w-12 h-12 object-contain drop-shadow-md"
            />
        </div>
    ) : (
        <div class={`absolute z-50 ${posClass}`} style={`top: ${cssTop}px;`}>
            <div
                class={`w-6 h-6 rounded-full ${cssColor} shadow-md border-2 border-white`}
            >
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-2 h-2 rounded-full bg-white/50" />
            </div>
            <div class="absolute top-5 left-1/2 -translate-x-1/2 w-1 h-2 bg-gray-400 rounded-b" />
        </div>
    )
}
