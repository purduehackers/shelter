---
import type { ShelterProject } from "../types/shelter";
import Pin from "./Pin.astro";

const CMS_URL = "https://cms.purduehackers.com";

interface Props {
    project: ShelterProject;
}

const { project } = Astro.props;

const imageUrl = project.image.url.startsWith("http")
    ? project.image.url
    : `${CMS_URL}${project.image.url}`;

// Seeded random for deterministic results
function seededRandom(s: number): () => number {
    return () => {
        s = (s * 1103515245 + 12345) & 0x7fffffff;
        return s / 0x7fffffff;
    };
}

function createSeed(str: string): number {
    let hash = 5381;
    for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) + hash + str.charCodeAt(i)) | 0;
    }
    return Math.abs(hash);
}

const seed = createSeed(
    `${project.name}${project.description}${project.last_owner}`,
);
const random = seededRandom(seed);

// Helper to pick from array using random
const pick = <T,>(arr: T[]): T => arr[Math.floor(random() * arr.length)];

// Deterministic "random" selection
const rotations = ["-2deg", "-1deg", "0deg", "1deg", "2deg"];
const cardRotation = pick(rotations);

const pinColors = [
    "bg-red-500",
    "bg-yellow-500",
    "bg-blue-500",
    "bg-green-500",
    "bg-pink-500",
];
const pinColor = pick(pinColors);

const stampRotations = ["-8deg", "-5deg", "-3deg", "3deg", "5deg", "8deg"];
const stampColors = [
    "text-red-700",
    "text-red-800",
    "text-rose-700",
    "text-red-900",
];
const stampOpacities = ["opacity-70", "opacity-75", "opacity-80", "opacity-85"];
const stampPositions = ["left-1", "right-1"];

const stampRotation = pick(stampRotations);
const stampColor = pick(stampColors);
const stampOpacity = pick(stampOpacities);
const stampPosition = pick(stampPositions);
---

<!-- SVG filter for stamp roughness -->
<svg class="hidden">
    <filter id="stamp-roughness">
        <feTurbulence
            type="fractalNoise"
            baseFrequency="0.04"
            numOctaves="5"
            result="noise"></feTurbulence>
        <feDisplacementMap
            in="SourceGraphic"
            in2="noise"
            scale="2"
            xChannelSelector="R"
            yChannelSelector="G"></feDisplacementMap>
    </filter>
</svg>

<a
    href={`/project/${project.id}`}
    class="group block pt-4 relative [transform-style:flat]"
    style={`--rotation: ${cardRotation}`}
>
    <!-- Push Pin - before article but with isolation -->
    <div
        class="absolute inset-0 z-50 pointer-events-none [transform-style:flat]"
    >
        <Pin
            seed={`${project.name}${project.description}${project.last_owner}`}
            cssColor={pinColor}
            topOffset={15}
        />
    </div>

    <article
        class="card-curl relative bg-white p-3 pb-4 transition-all duration-300 ease-out [transform:rotate(var(--rotation))]"
        style="max-width: 280px;"
    >
        <!-- Polaroid-style image -->
        <div class="bg-gray-100 aspect-square overflow-hidden">
            <img
                src={imageUrl}
                alt={project.image.alt || project.name}
                class="w-full h-full object-cover transition-transform duration-300"
                loading="lazy"
            />
        </div>

        <!-- Project Info -->
        <div class="mt-3 text-center">
            <h2 class="font-handwriting text-2xl text-gray-800 leading-tight">
                {project.name}
            </h2>
            <div class="mt-2 space-y-1">
                <p class="text-xs text-gray-500 uppercase tracking-wide">
                    Last seen with
                </p>
                <p class="text-sm font-medium text-gray-700">
                    {project.last_owner}
                </p>
                <p class="text-xs text-gray-500">
                    {project.last_division}
                </p>
            </div>
        </div>

        <!-- "Adopt Me" stamp -->
        <div
            class={`stamp absolute bottom-6 ${stampPosition} ${stampColor} ${stampOpacity} font-stamp text-xs uppercase tracking-widest border-[3px] border-current rounded-sm px-2 py-1 pointer-events-none`}
            style={`transform: rotate(${stampRotation});`}
        >
            Adopt Me!
        </div>

        <!-- Paper texture overlay -->
        <div
            class="absolute inset-0 pointer-events-none opacity-10 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjZmZmIj48L3JlY3Q+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiNjY2MiPjwvcmVjdD4KPC9zdmc+')]"
        >
        </div>
    </article>
</a>

<style>
    .font-handwriting {
        font-family: "Caveat", cursive;
    }
    .font-stamp {
        font-family: "Courier New", Courier, monospace;
        font-weight: 900;
    }
    .stamp {
        filter: url(#stamp-roughness);
        mix-blend-mode: multiply;
    }
    .card-curl {
        transform-style: preserve-3d;
        transform-origin: top center;
        box-shadow: 2px 4px 8px rgba(0, 0, 0, 0.2);
        transition:
            transform 0.3s ease-out,
            box-shadow 0.3s ease-out;
    }
    .group:hover .card-curl {
        transform: rotate(var(--rotation)) perspective(800px) rotateX(2deg);
        box-shadow:
            4px 30px 60px rgba(0, 0, 0, 0.4),
            2px 15px 30px rgba(0, 0, 0, 0.3),
            1px 5px 15px rgba(0, 0, 0, 0.2);
    }
    .card-curl::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 50%;
        background: linear-gradient(
            to bottom,
            transparent 0%,
            rgba(0, 0, 0, 0.08) 100%
        );
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s ease-out;
    }
    .group:hover .card-curl::after {
        opacity: 1;
    }
</style>
