---
import Layout from '../../layouts/Layout.astro';
import type { ShelterProject } from '../../types/shelter';

export const prerender = false;

const CMS_URL = 'https://cms.purduehackers.com';

const { id } = Astro.params;

let project: ShelterProject | null = null;
let error: string | null = null;

try {
  const response = await fetch(`${CMS_URL}/api/shelter-projects/${id}?depth=1`);
  if (!response.ok) {
    if (response.status === 404) {
      return Astro.redirect('/404');
    }
    throw new Error(`Failed to fetch project: ${response.status}`);
  }
  project = await response.json();
} catch (e) {
  error = e instanceof Error ? e.message : 'Failed to load project';
  console.error('Error fetching project:', e);
}

const imageUrl = project?.image.url.startsWith('http')
  ? project.image.url
  : `${CMS_URL}${project?.image.url}`;
---

<Layout title={project ? `${project.name} - Project Shelter` : 'Project Not Found'}>
  <div class="min-h-screen bg-amber-700 relative">
    <!-- Cork texture layers -->
    <div class="absolute inset-0 cork-texture"></div>
    <div class="absolute inset-0 opacity-40 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj4KPGZpbHRlciBpZD0ibm9pc2UiPgo8ZmVUdXJidWxlbmNlIHR5cGU9ImZyYWN0YWxOb2lzZSIgYmFzZUZyZXF1ZW5jeT0iMC44IiBudW1PY3RhdmVzPSI0IiBzdGl0Y2hUaWxlcz0ic3RpdGNoIi8+CjwvZmlsdGVyPgo8cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsdGVyPSJ1cmwoI25vaXNlKSIgb3BhY2l0eT0iMC41Ii8+Cjwvc3ZnPg==')]"></div>
    <div class="absolute inset-0 opacity-20 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2MCIgaGVpZ2h0PSI2MCI+CjxyZWN0IHdpZHRoPSI2MCIgaGVpZ2h0PSI2MCIgZmlsbD0iI2Q0YTU3NCI+PC9yZWN0Pgo8Y2lyY2xlIGN4PSIzMCIgY3k9IjMwIiByPSIyMCIgZmlsbD0iI2M5OWE2OSIgb3BhY2l0eT0iMC41Ij48L2NpcmNsZT4KPGNpcmNsZSBjeD0iMTAiIGN5PSIxMCIgcj0iOCIgZmlsbD0iI2JlOGY1ZSIgb3BhY2l0eT0iMC4zIj48L2NpcmNsZT4KPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iMTIiIGZpbGw9IiNkOWFhNzkiIG9wYWNpdHk9IjAuNCI+PC9jaXJjbGU+Cjwvc3ZnPg==')]"></div>
    <!-- Speckle overlay -->
    <div class="absolute inset-0 opacity-30 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj4KPGNpcmNsZSBjeD0iMTAiIGN5PSIxNSIgcj0iMiIgZmlsbD0iIzhhNjM0MiIgb3BhY2l0eT0iMC40Ii8+CjxjaXJjbGUgY3g9IjUwIiBjeT0iMzAiIHI9IjEuNSIgZmlsbD0iI2E4N2M1MCIgb3BhY2l0eT0iMC4zIi8+CjxjaXJjbGUgY3g9IjkwIiBjeT0iMjAiIHI9IjIuNSIgZmlsbD0iIzZkNGMyOCIgb3BhY2l0eT0iMC41Ii8+CjxjaXJjbGUgY3g9IjEzMCIgY3k9IjQ1IiByPSIxLjgiIGZpbGw9IiM5YTZiM2UiIG9wYWNpdHk9IjAuNCIvPgo8Y2lyY2xlIGN4PSIxNzAiIGN5PSIyNSIgcj0iMiIgZmlsbD0iIzdiNTMzMCIgb3BhY2l0eT0iMC4zNSIvPgo8Y2lyY2xlIGN4PSIyNSIgY3k9IjcwIiByPSIyLjIiIGZpbGw9IiNhNTc4NGEiIG9wYWNpdHk9IjAuNDUiLz4KPGNpcmNsZSBjeD0iNzAiIGN5PSI4NSIgcj0iMS41IiBmaWxsPSIjOGE2MzQyIiBvcGFjaXR5PSIwLjMiLz4KPGNpcmNsZSBjeD0iMTEwIiBjeT0iNzUiIHI9IjIuOCIgZmlsbD0iIzZkNGMyOCIgb3BhY2l0eT0iMC40Ii8+CjxjaXJjbGUgY3g9IjE1MCIgY3k9IjkwIiByPSIxLjgiIGZpbGw9IiM5YTZiM2UiIG9wYWNpdHk9IjAuMzUiLz4KPGNpcmNsZSBjeD0iMTg1IiBjeT0iNjUiIHI9IjIuMiIgZmlsbD0iI2E1Nzg0YSIgb3BhY2l0eT0iMC40NSIvPgo8Y2lyY2xlIGN4PSIzNSIgY3k9IjEyMCIgcj0iMiIgZmlsbD0iIzdiNTMzMCIgb3BhY2l0eT0iMC4zIi8+CjxjaXJjbGUgY3g9IjgwIiBjeT0iMTQwIiByPSIyLjUiIGZpbGw9IiM4YTYzNDIiIG9wYWNpdHk9IjAuNCIvPgo8Y2lyY2xlIGN4PSIxMjUiIGN5PSIxMjUiIHI9IjEuNSIgZmlsbD0iI2E4N2M1MCIgb3BhY2l0eT0iMC4zNSIvPgo8Y2lyY2xlIGN4PSIxNjUiIGN5PSIxNDUiIHI9IjIuMiIgZmlsbD0iIzZkNGMyOCIgb3BhY2l0eT0iMC40NSIvPgo8Y2lyY2xlIGN4PSIxNSIgY3k9IjE3MCIgcj0iMS44IiBmaWxsPSIjOWE2YjNlIiBvcGFjaXR5PSIwLjMiLz4KPGNpcmNsZSBjeD0iNTUiIGN5PSIxODUiIHI9IjIuNSIgZmlsbD0iI2E1Nzg0YSIgb3BhY2l0eT0iMC40Ii8+CjxjaXJjbGUgY3g9Ijk1IiBjeT0iMTY1IiByPSIyIiBmaWxsPSIjN2I1MzMwIiBvcGFjaXR5PSIwLjM1Ii8+CjxjaXJjbGUgY3g9IjE0MCIgY3k9IjE4MCIgcj0iMS41IiBmaWxsPSIjOGE2MzQyIiBvcGFjaXR5PSIwLjQ1Ii8+CjxjaXJjbGUgY3g9IjE4MCIgY3k9IjE3MCIgcj0iMi44IiBmaWxsPSIjNmQ0YzI4IiBvcGFjaXR5PSIwLjMiLz4KPC9zdmc+')]"></div>

    <!-- Wood frame border -->
    <div class="absolute inset-0 border-[16px] border-amber-950 shadow-inner pointer-events-none" style="box-shadow: inset 0 0 30px rgba(0,0,0,0.5), inset 0 0 60px rgba(0,0,0,0.2);"></div>

    <!-- Content -->
    <div class="relative z-10 px-8 py-12 md:px-16 md:py-16">
      <!-- Back button -->
      <a
        href="/"
        class="inline-flex items-center gap-2 text-amber-100 hover:text-white transition-colors mb-8 font-handwriting text-xl"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
        </svg>
        Back to all projects
      </a>

      {error ? (
        <div class="max-w-md mx-auto bg-white/90 p-6 rounded-lg shadow-lg text-center">
          <p class="text-red-600 font-medium">Oops! {error}</p>
          <p class="text-gray-600 mt-2">Please try again later.</p>
        </div>
      ) : project ? (
        <div class="max-w-4xl mx-auto">
          <!-- Main card -->
          <article class="bg-white p-6 md:p-10 shadow-2xl relative">
            <!-- Push pins -->
            <div class="absolute -top-3 left-8">
              <div class="w-6 h-6 rounded-full bg-red-500 shadow-md border-2 border-white">
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-2 h-2 rounded-full bg-white/50"></div>
              </div>
            </div>
            <div class="absolute -top-3 right-8">
              <div class="w-6 h-6 rounded-full bg-blue-500 shadow-md border-2 border-white">
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-2 h-2 rounded-full bg-white/50"></div>
              </div>
            </div>

            <div class="md:flex gap-8">
              <!-- Image -->
              <div class="md:w-1/2 mb-6 md:mb-0">
                <div class="bg-gray-100 p-3 shadow-md">
                  <img
                    src={imageUrl}
                    alt={project.image.alt || project.name}
                    class="w-full aspect-square object-cover"
                  />
                </div>
              </div>

              <!-- Info -->
              <div class="md:w-1/2">
                <h1 class="text-4xl md:text-5xl font-handwriting text-gray-800 mb-4">
                  {project.name}
                </h1>

                <!-- Stats - Sticky note style -->
                <div class="bg-yellow-100 p-4 mb-6 shadow-md transform -rotate-1 relative" style="box-shadow: 2px 3px 8px rgba(0,0,0,0.2);">
                  <div class="absolute top-0 right-0 w-0 h-0 border-l-[16px] border-l-yellow-200 border-b-[16px] border-b-transparent"></div>
                  <h2 class="font-handwriting text-xl text-amber-900 mb-2">
                    Project Details
                  </h2>
                  <dl class="space-y-1 font-handwriting text-lg">
                    <div class="flex justify-between">
                      <dt class="text-amber-700">Last Owner:</dt>
                      <dd class="text-amber-900">{project.last_owner}</dd>
                    </div>
                    <div class="flex justify-between">
                      <dt class="text-amber-700">Last Division:</dt>
                      <dd class="text-amber-900">{project.last_division}</dd>
                    </div>
                  </dl>
                </div>

                <!-- Description -->
                <div class="mb-8">
                  <h2 class="text-sm font-bold text-gray-600 uppercase tracking-wide mb-2">
                    About This Project
                  </h2>
                  <p class="text-gray-700 leading-relaxed whitespace-pre-wrap">
                    {project.description}
                  </p>
                </div>

                <!-- CTA - Sticky note style -->
                <div class="bg-green-100 p-4 shadow-md transform rotate-1 relative" style="box-shadow: 2px 3px 8px rgba(0,0,0,0.2);">
                  <div class="absolute top-0 right-0 w-0 h-0 border-l-[16px] border-l-green-200 border-b-[16px] border-b-transparent"></div>
                  <p class="font-handwriting text-xl text-green-800 mb-1">
                    Interested in adopting?
                  </p>
                  <p class="font-handwriting text-lg text-green-700">
                    Reach out to an organizer to claim this project and give it a new home!
                  </p>
                </div>
              </div>
            </div>

            <!-- Paper texture overlay -->
            <div class="absolute inset-0 pointer-events-none opacity-5 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjZmZmIj48L3JlY3Q+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiNjY2MiPjwvcmVjdD4KPC9zdmc+')]"></div>
          </article>

          <!-- Share link -->
          <div class="mt-6 text-center">
            <p class="text-amber-200 text-sm">
              Share this project:
              <span class="font-mono bg-amber-900/50 px-2 py-1 rounded text-amber-100">
                {Astro.url.href}
              </span>
            </p>
          </div>
        </div>
      ) : null}

      <!-- Footer -->
      <footer class="mt-16 text-center">
        <p class="text-amber-200/70 font-handwriting text-lg">
          A Purdue Hackers Initiative ðŸ’›
        </p>
      </footer>
    </div>
  </div>
</Layout>

<style>
  .font-handwriting {
    font-family: 'Caveat', cursive;
  }
  .cork-texture {
    background:
      radial-gradient(ellipse at 20% 30%, rgba(180, 120, 60, 0.4) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 20%, rgba(160, 100, 50, 0.3) 0%, transparent 40%),
      radial-gradient(ellipse at 40% 80%, rgba(190, 130, 70, 0.35) 0%, transparent 45%),
      radial-gradient(ellipse at 70% 60%, rgba(150, 95, 45, 0.3) 0%, transparent 50%),
      radial-gradient(ellipse at 10% 70%, rgba(170, 110, 55, 0.25) 0%, transparent 35%),
      radial-gradient(ellipse at 90% 85%, rgba(185, 125, 65, 0.3) 0%, transparent 40%);
  }
</style>
